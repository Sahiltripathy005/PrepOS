generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String             @id @default(uuid())
  name             String
  email            String             @unique
  passwordHash     String
  createdAt        DateTime           @default(now())
  attemptLogs      AttemptLog[]
  goals            Goal[]
  readinessHistory ReadinessHistory[]
  tasks            Task[]
  topicStats       TopicStat[]
}

model Goal {
  id              String   @id @default(uuid())
  userId          String
  targetRole      String
  targetCompanies Json
  timelineDays    Int
  hoursPerDay     Int
  startDate       DateTime
  wDsa            Float
  wApti           Float
  wCs             Float
  wDev            Float
  difficultyCurve String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Topic {
  id              Int          @id @default(autoincrement())
  parentId        Int?
  name            String
  importanceScore Int
  category        String
  attemptLogs     AttemptLog[]
  tasks           Task[]
  parent          Topic?       @relation("TopicToTopic", fields: [parentId], references: [id])
  children        Topic[]      @relation("TopicToTopic")
  topicStats      TopicStat[]

  @@index([category])
  @@index([parentId])
}

model Task {
  id          String       @id @default(uuid())
  userId      String
  date        DateTime
  topicId     Int?
  title       String
  durationMin Int
  type        String
  difficulty  String
  status      String       @default("pending")
  createdBy   String       @default("system")
  attemptLogs AttemptLog[]
  topic       Topic?       @relation(fields: [topicId], references: [id])
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, title])
  @@index([userId])
  @@index([date])
  @@index([topicId])
  @@index([userId, date])
}

model AttemptLog {
  id           String   @id @default(uuid())
  userId       String
  taskId       String?
  topicId      Int
  correct      Boolean
  timeTakenSec Int
  confidence   Int
  mistakeTag   String
  createdAt    DateTime @default(now())
  difficulty   String
  task         Task?    @relation(fields: [taskId], references: [id])
  topic        Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([topicId])
  @@index([createdAt])
}

model TopicStat {
  id               String    @id @default(uuid())
  userId           String
  topicId          Int
  attemptsTotal    Int       @default(0)
  correctTotal     Int       @default(0)
  avgTimeSec       Int       @default(0)
  masteryScore     Float     @default(0)
  lastPracticedAt  DateTime?
  nextRevisionDate DateTime?
  topic            Topic     @relation(fields: [topicId], references: [id], onDelete: Cascade)
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
  @@index([userId])
  @@index([topicId])
  @@index([nextRevisionDate])
}

model ReadinessHistory {
  id      String   @id @default(uuid())
  userId  String
  date    DateTime
  overall Float
  dsa     Float
  apti    Float
  cs      Float
  dev     Float
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
}
